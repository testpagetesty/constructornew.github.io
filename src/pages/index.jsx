import React, { useState, useEffect } from 'react';
import { Box, Container, Grid, useMediaQuery, useTheme } from '@mui/material';
import EditorPanel from '../components/Editor/EditorPanel';
import PagePreview from '../components/Preview/PagePreview';
import HeroEditor from '../components/Editor/HeroEditor';
import { CARD_TYPES } from '../utils/configUtils';
import AiParser from '../components/AiParser/AiParser';

const initialHeaderData = {
  siteName: '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è "–ü—Ä–∞–≤–æ –∏ –ó–∞—â–∏—Ç–∞"',
  title: '', // –ü—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–∑ siteName
  description: '–ù–∞—à —Å–∞–π—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ª—É—á—à–∏–µ —Ä–µ—à–µ–Ω–∏—è', // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  titleColor: '#2196f3',
  backgroundColor: '#e3f2fd',
  linksColor: '#1976d2',
  domain: '',
  siteBackgroundColor: '#f8f9fa',
  siteBackgroundType: 'gradient',
  siteGradientColor1: '#e3f2fd',
  siteGradientColor2: '#bbdefb',
  siteGradientDirection: 'to right',
  menuItems: [],
  contactLink: {
    show: true,
    text: '–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏',
    url: '#contact',
    color: '#000000'
  },
  logo: {
    show: true,
    url: '',
    alt: '–õ–æ–≥–æ—Ç–∏–ø –∫–æ–º–ø–∞–Ω–∏–∏'
  },
  phone: {
    show: true,
    number: '+7 (XXX) XXX-XX-XX',
    color: '#000000'
  },
  email: {
    show: true,
    address: 'info@example.com',
    color: '#000000'
  },
  socialLinks: {
    show: true,
    facebook: '#',
    twitter: '#',
    instagram: '#',
    linkedin: '#'
  },
  search: {
    show: true,
    placeholder: '–ü–æ–∏—Å–∫...'
  },
  language: {
    show: true,
    current: 'ru',
    options: ['ru', 'en']
  },
  styles: {
    headerHeight: '80px',
    menuItemSpacing: '20px',
    menuItemHoverColor: '#1976d2',
    menuItemActiveColor: '#1565c0',
    menuItemFontSize: '16px',
    menuItemFontWeight: '500',
    menuItemTransition: '0.3s',
    logoWidth: '150px',
    logoHeight: 'auto',
    contactButtonPadding: '8px 16px',
    contactButtonBorderRadius: '4px',
    contactButtonBackground: '#1976d2',
    contactButtonHoverBackground: '#1565c0',
    searchWidth: '200px',
    searchBorderRadius: '4px',
    searchBorderColor: '#e0e0e0',
    searchFocusBorderColor: '#1976d2',
    socialIconSize: '24px',
    socialIconColor: '#000000',
    socialIconHoverColor: '#1976d2',
    languageSelectorWidth: '100px',
    languageSelectorBorderRadius: '4px',
    languageSelectorBorderColor: '#e0e0e0',
    boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
    zIndex: 1000,
    sticky: true,
    transparent: false,
    blurEffect: false,
    blurAmount: 5
  }
};

const initialHeroData = {
  title: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —É—Å–ª—É–≥–∏',
  subtitle: '',
  backgroundType: 'image',
  backgroundColor: '#ffffff',
  gradientColor1: '#ffffff',
  gradientColor2: '#f5f5f5',
  gradientDirection: 'to right',
  backgroundImage: '/images/hero/hero.jpg',
  titleColor: '#2196f3',
  subtitleColor: '#64b5f6',
  animationType: 'zoom',
  enableOverlay: true,
  overlayOpacity: 0.1,
  enableBlur: true,
  blurAmount: 0.1,
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–µ–∑–∫–∏ –≤–∏–¥–µ–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω—ã
  videoCropBottom: false,
  videoCropRight: false,
  videoCropTop: false,
  videoRemovePostback: false
};

const initialSectionsData = [];

const initialContactData = {
  title: '–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏',
  description: '–û—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∏ –º—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è. –ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ —é—Ä–∏—Å—Ç–æ–≤ –≥–æ—Ç–æ–≤–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤—Å–µ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.',
  companyName: '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è "–ü—Ä–∞–≤–æ –∏ –ó–∞—â–∏—Ç–∞"',
  address: '–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –Ø–∫–∏–º–∞–Ω–∫–∞, –¥. 12',
  phone: '+7 (495) 123-45-67',
  email: 'info@pravo-zashita.ru',
  mapCoordinates: {
    lat: 55.7558,
    lng: 37.6173
  },
  titleColor: '#1a237e',
  descriptionColor: '#283593',
  companyInfoColor: '#0d47a1',
  formVariant: 'outlined',
  infoVariant: 'outlined',
  formBackgroundColor: '#ffffff',
  infoBackgroundColor: '#ffffff',
  formBorderColor: '#d32f2f',
  infoBorderColor: '#b71c1c',
  formBorderWidth: '5px',
  infoBorderWidth: '5px',
  titleFont: 'bold',
  textFont: 'default'
};

const initialFooterData = {
  backgroundColor: '#d32f2f',
  textColor: '#ffffff',
  companyName: '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è "–ü—Ä–∞–≤–æ –∏ –ó–∞—â–∏—Ç–∞"',
  phone: '+7 (495) 123-45-67',
  email: 'info@pravo-zashita.ru',
  address: '–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –Ø–∫–∏–º–∞–Ω–∫–∞, –¥. 12',
  showSocialLinks: true,
  socialLinks: {
    facebook: '#',
    twitter: '#',
    instagram: '#',
    linkedin: '#'
  },
  copyrightYear: new Date().getFullYear(),
  copyrightText: '–í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã',
  legalDocuments: {
    privacyPolicyTitle: '–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏',
    termsOfServiceTitle: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ',
    cookiePolicyTitle: '–ü–æ–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è cookie'
  }
};

const saveDocumentToFile = async (documentName, content) => {
  try {
    if (!content) {
      console.warn(`Empty content for ${documentName}`);
      return;
    }

    const response = await fetch('/api/save-document', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        documentName,
        content: content.trim() // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
      }),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(`Failed to save document: ${errorData.message || response.statusText}`);
    }

    const data = await response.json();
    console.log(`Successfully saved ${documentName}:`, data);
    return data;
  } catch (error) {
    console.error(`Error saving ${documentName}:`, error);
    throw error; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã—à–µ
  }
};

export default function Home() {
  const [headerData, setHeaderData] = useState(initialHeaderData);
  const [heroData, setHeroData] = useState(initialHeroData);
  const [sectionsData, setSectionsData] = useState(initialSectionsData);
  const [contactData, setContactData] = useState(initialContactData);
  const [footerData, setFooterData] = useState({
    ...initialFooterData,
    menuItems: initialHeaderData.menuItems,
    showSocialLinks: false,
    legalDocuments: {
      privacyPolicyTitle: '–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏',
      termsOfServiceTitle: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ',
      cookiePolicyTitle: '–ü–æ–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è cookie',
      privacyPolicy: '–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏',
      termsOfService: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ',
      cookiePolicy: '–ü–æ–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è cookie'
    }
  });
  const [liveChatData, setLiveChatData] = useState({
    enabled: true,
    apiKey: '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'
  });

  console.log('Home component state:', {
    headerData,
    heroData,
    sectionsData,
    contactData,
    footerData
  });

  const handleHeaderChange = (newHeaderData) => {
    console.log('handleHeaderChange called with:', newHeaderData);
    setHeaderData(newHeaderData);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É—Ç–µ—Ä
    setFooterData(prev => {
      const newFooterData = {
        ...prev,
        menuItems: newHeaderData.menuItems,
        backgroundColor: newHeaderData.backgroundColor,
        textColor: newHeaderData.titleColor,
        companyNameColor: newHeaderData.titleColor,
        phoneColor: newHeaderData.titleColor,
        emailColor: newHeaderData.titleColor,
        addressColor: newHeaderData.titleColor,
        copyrightTextColor: newHeaderData.titleColor,
        socialLinksColor: newHeaderData.titleColor,
        menuItemsColor: newHeaderData.titleColor,
        legalDocumentsColor: newHeaderData.titleColor
      };
      console.log('Footer data updated:', newFooterData);
      return newFooterData;
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º hero —Å–µ–∫—Ü–∏—é
    setHeroData(prev => {
      const newHeroData = {
        ...prev,
        titleColor: newHeaderData.titleColor,
        subtitleColor: newHeaderData.linksColor
      };
      console.log('Hero data updated:', newHeroData);
      return newHeroData;
    });
  };

  const handleHeroChange = (newHeroData) => {
    console.log('üé¨ handleHeroChange called with:', newHeroData);
    console.log('üé¨ –ü—Ä–µ–¥—ã–¥—É—â–∏–π heroData:', heroData);
    setHeroData(newHeroData);
  };

  const handleSectionsChange = (newSectionsData) => {
    console.log('handleSectionsChange called with:', newSectionsData);
    setSectionsData(newSectionsData);
  };

  const handleContactChange = (newContactData) => {
    console.log('handleContactChange called with:', newContactData);
    setContactData(newContactData);
  };

  const handleFooterChange = (newFooterData) => {
    console.log('handleFooterChange called with:', newFooterData);
    setFooterData(newFooterData);
  };

  const handleLegalDocumentsChange = async (documents) => {
    console.log('handleLegalDocumentsChange called with:', documents);
    
    try {
      // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      setFooterData(prev => {
        const newData = {
          ...prev,
          legalDocuments: {
            ...prev.legalDocuments,
            ...documents
          }
        };
        console.log('Footer data updated with legal documents:', newData);
        return newData;
      });

      // –ó–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª—ã
      const savePromises = [
        saveDocumentToFile('privacy-policy', documents.privacyPolicy),
        saveDocumentToFile('terms-of-service', documents.termsOfService),
        saveDocumentToFile('cookie-policy', documents.cookiePolicy)
      ];

      const results = await Promise.allSettled(savePromises);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      const hasErrors = results.some(result => result.status === 'rejected');
      if (hasErrors) {
        console.error('Some documents failed to save:', results);
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± –æ—à–∏–±–∫–µ
      }
    } catch (error) {
      console.error('Error in handleLegalDocumentsChange:', error);
      // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± –æ—à–∏–±–∫–µ
    }
  };

  const handleLiveChatChange = (newLiveChatData) => {
    console.log('handleLiveChatChange called with:', newLiveChatData);
    setLiveChatData(newLiveChatData);
  };

  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down('md'));

  return (
    <Box sx={{ 
      display: 'flex', 
      flexDirection: isMobile ? 'column' : 'row',
      height: isMobile ? 'auto' : '100vh'
    }}>
      <Box sx={{ 
        width: isMobile ? '100%' : '400px',
        flexShrink: 0,
        borderRight: isMobile ? 'none' : '1px solid #e0e0e0',
        borderBottom: isMobile ? '1px solid #e0e0e0' : 'none',
        overflow: 'auto',
        maxHeight: isMobile ? '50vh' : '100vh',
        '&::-webkit-scrollbar': {
          width: '4px',
        },
        '&::-webkit-scrollbar-track': {
          background: '#f1f1f1',
        },
        '&::-webkit-scrollbar-thumb': {
          background: '#888',
          borderRadius: '2px',
        },
      }}>
        <EditorPanel
          headerData={headerData}
          onHeaderChange={handleHeaderChange}
          sectionsData={sectionsData}
          onSectionsChange={handleSectionsChange}
          heroData={heroData}
          onHeroChange={handleHeroChange}
          contactData={contactData}
          onContactChange={handleContactChange}
          footerData={footerData}
          onFooterChange={handleFooterChange}
          legalDocuments={footerData.legalDocuments}
          onLegalDocumentsChange={handleLegalDocumentsChange}
          liveChatData={liveChatData}
          onLiveChatChange={handleLiveChatChange}
        />
      </Box>
      <Box sx={{ 
        flexGrow: 1, 
        overflow: 'auto',
        height: isMobile ? '50vh' : '100vh',
        display: 'flex',
        flexDirection: 'column'
      }}>
        <PagePreview
          headerData={headerData}
          heroData={heroData}
          sectionsData={sectionsData}
          footerData={footerData}
          contactData={contactData}
          legalDocuments={footerData.legalDocuments}
          liveChatData={liveChatData}
        />
      </Box>
    </Box>
  );
} 